name: ðŸ“¦ Release

on:
  release:
    types: [published]

jobs:
  datamodel-dumps-documentation:
    name: Call Datamodel Create Dumps Workflow
    uses: ./.github/workflows/datamodel-dumps-documentation.yml
    with:
      release_tag: ${{ github.event.release.tag_name }}

  project-translations:
    name: Call Project Translations Workflow
    uses: ./.github/workflows/project-translation-package.yml
    with:
      release_tag: ${{ github.event.release.tag_name }}
    secrets: inherit

  deploy-demo-db:
    name: Deploy Demo Database
    runs-on: ubuntu-latest

    env:
      TX_TOKEN: ${{ secrets.TX_TOKEN }}
      DEMO_DATA: Lausanne
      REMOTE_DEMO_DB_NAME: signalo_stable
      PGSERVICE: pg_signalo
      DB_NAME: signalo

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Deploy Demo DB
        run: |
          set -euxo pipefail
          docker compose down -v
          # Write pg_service.conf with the remote service definition
          cat > pg_service.conf <<EOF
          [remote_db]
          host=${{ secrets.DEMO_DB_HOST }}
          port=${{ secrets.DEMO_DB_PORT }}
          dbname=${{ env.REMOTE_DEMO_DB_NAME }}
          user=${{ secrets.DEMO_DB_USER }}
          password=${{ secrets.DEMO_DB_PASSWORD }}
          EOF
          export PGSERVICE="remote_db"
          export PGSERVICEFILE="$(pwd)/pg_service.conf"
          docker compose up -d
          docker compose exec -e PGSERVICE=remote_db db psql -v ON_ERROR_STOP=1 -c "DROP SCHEMA IF EXISTS signalo_app CASCADE; DROP SCHEMA IF EXISTS signalo_db CASCADE;"
          docker compose run pum -vvv -s remote_db -d datamodel install -p SRID 2056 --demo-data ${DEMO_DATA} --roles --grant


  rebuild-website:
    uses: ./.github/workflows/website.yml
    secrets: inherit
    needs: datamodel-dumps-documentation
