name: ðŸ§ª Run tests and deploy demo data

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'website/**'
      - '.github/workflows/website.yml'
  pull_request:
    branches:
      - main
    paths-ignore:
      - 'website/**'
      - '.github/workflows/website.yml'
  workflow_dispatch:


jobs:
  docker-tests:
    name: Run tests and deploy demo data
    runs-on: ubuntu-latest

    env:
      DOCKER_TAG: opengisch/signalo:unstable
      DB_NAME: signalo
      PG_SERVICE: pg_signalo
      DEMO_DATA: Lausanne
      TEST_PACKAGES: "exiftool bc"

    steps:
      - uses: actions/checkout@v5

      - name: "build dockerfile"
        run: |
          docker build -f datamodel/.docker/Dockerfile \
            --build-arg RUN_TEST=True \
            --build-arg DB_NAME=${DB_NAME} \
            --build-arg PG_SERVICE=${PG_SERVICE} \
            --build-arg TEST_PACKAGES="${TEST_PACKAGES}" \
            --tag ${DOCKER_TAG} .

      - name: Initialize container
        run: |
          docker run -d -p 5432:5432 -v $(pwd):/usr/src --name pum_db_container ${DOCKER_TAG}
          until docker exec pum_db_container pg_isready -U postgres; do
            echo "Waiting for PostgreSQL to be ready..."
            sleep 2
          done
          # create the database
          docker exec pum_db_container sh -c "createdb ${DB_NAME}"
          docker exec pum_db_container sh -c "createdb ${DB_NAME}_demo"
          docker exec pum_db_container pum -vvv -s ${PG_SERVICE} -d datamodel install -p SRID 2056 --roles --grant
          docker exec pum_db_container pum -vvv -s ${PG_SERVICE}_demo -d datamodel install -p SRID 2056 --demo-data ${DEMO_DATA} --roles --grant

      - name: "dumps + all signs"
        run: |
          docker exec pum_db_container pg_dump --format custom --exclude-schema=public --blobs --compress 5 --file signalo-testing-db-dump-with-demo.backup ${DB_NAME}_demo
          docker exec -e PGSERVICE=${PG_SERVICE}_demo pum_db_container /usr/src/scripts/all-signs.py

#      - uses: actions/setup-node@v3
#        with:
#          node-version: '18'

      - name: "test data model"
        run: docker exec pum_db_container pytest

      - name: "test images"
        run: docker exec pum_db_container /usr/src/test/official_sign_images.sh

#      - name: "schema lint"
#        run: |
#          npm i --no-fund -g schemalint
#          cp .schemalintrc.js.template .schemalintrc.js
#          schemalint

      - name: Login to DockerHub
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: "push to dockerhub"
        if: github.event_name != 'pull_request'
        run: |
          docker push opengisch/signalo:unstable

      - name: Fix workspace permissions
        if: github.event_name != 'pull_request'
        run: sudo chown -R $USER:$USER ${GITHUB_WORKSPACE}

      - name: Deploy Demo DB
        if: github.event_name != 'pull_request'
        uses: ./.github/actions/deploy-demo-db
        with:
          demo_db_host: ${{ secrets.DEMO_DB_HOST }}
          demo_db_user: ${{ secrets.DEMO_DB_USER }}
          demo_db_port: ${{ secrets.DEMO_DB_PORT }}
          demo_db_name: signalo_testing
          demo_db_password: ${{ secrets.DEMO_DB_PASSWORD }}
          demo_db_backup_file: signalo-testing-db-dump-with-demo.backup
          viewer_role: signalo_viewer
          user_role: signalo_user

      - name: "failure logs"
        if: failure()
        run: |
          docker logs pum_db_container

      - uses: actions/upload-artifact@v5
        id: artifact
        if: github.event_name == 'pull_request'
        with:
          name: signalo-pr-testing
          path: |
            signalo-testing-db-dump-with-demo.backup
            project

      - name: Schedule download comment
        uses: ./.github/actions/post_sticky_comment
        if: github.event_name == 'pull_request'
        with:
          marker: pr-testing
          body: |
            ### Testing
            Download [demo data dump and QGIS project](${{ steps.artifact.outputs.artifact-url }}).
            *(Built from commit ${{ github.event.pull_request.head.sha }})*
          pr: ${{ github.event.number }}
