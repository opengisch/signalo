name: ðŸ§ª Run tests and deploy demo data

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'website/**'
      - '.github/workflows/website.yml'
  pull_request:
    branches:
      - main
    paths-ignore:
      - 'website/**'
      - '.github/workflows/website.yml'
  workflow_dispatch:


jobs:
  docker-tests:
    name: Run tests and deploy demo data
    runs-on: ubuntu-latest

    env:
      DEMO_DATA: Lausanne
      REMOTE_DEMO_DB_NAME: signalo_testing
      PG_SERVICE: pg_signalo
      DB_NAME: signalo

    steps:
      - uses: actions/checkout@v5

      - name: Initialize container
        run: |
          docker compose up --env RUN_TESTS=True --build -d
          until docker compose exec db pg_isready -U postgres; do
            echo "Waiting for PostgreSQL to be ready..."
            sleep 2
          done
          # create the database
          docker compose exec db sh -c "createdb -U postgres ${DB_NAME}"
          docker compose exec db sh -c "createdb -U postgres ${DB_NAME}_demo"
          docker compose run --rm pum pum -vvv -s ${PG_SERVICE} -d datamodel install -p SRID 2056 --roles --grant
          docker compose run --rm pum pum -vvv -s ${PG_SERVICE}_demo -d datamodel install -p SRID 2056 --demo-data ${DEMO_DATA} --roles --grant

      - name: "dumps + all signs"
        run: |
          docker compose exec db pg_dump -U postgres --format custom --exclude-schema=public --blobs --compress 5 --file signalo-testing-db-dump-with-demo.backup ${DB_NAME}_demo
          docker compose run --rm pum /usr/src/scripts/all-signs.py

#      - uses: actions/setup-node@v3
#        with:
#          node-version: '18'

      - name: "test data model"
        run: docker compose run --rm pum pytest

      - name: "test images"
        run: docker compose run --rm pum /usr/src/test/official_sign_images.sh

#      - name: "schema lint"
#        run: |
#          npm i --no-fund -g schemalint
#          cp .schemalintrc.js.template .schemalintrc.js
#          schemalint

      - name: Fix workspace permissions
        if: github.event_name != 'pull_request'
        run: sudo chown -R $USER:$USER ${GITHUB_WORKSPACE}

      - name: Deploy Demo DB
        if: github.event_name != 'pull_request'
        run: |
          set -euxo pipefail
          # Write pg_service.conf with the remote service definition
          cat > pg_service.conf <<EOF
          [remote_db]
          host=${{ secrets.DEMO_DB_HOST }}
          port=${{ secrets.DEMO_DB_PORT }}
          dbname=${{ env.REMOTE_DEMO_DB_NAME }}
          user=${{ secrets.DEMO_DB_USER }}
          password=${{ secrets.DEMO_DB_PASSWORD }}
          EOF
          docker compose down -v
          docker compose up --env PGSERVICE="remote_db" --env PGSERVICEFILE="/usr/src/pg_service.conf" -d
          docker compose run pum psql -v ON_ERROR_STOP=1 -c "DROP SCHEMA IF EXISTS signalo_app CASCADE; DROP SCHEMA IF EXISTS signalo_db CASCADE;"
          docker compose run pum pum -vvv -s remote_db -d datamodel install -p SRID 2056 --demo-data ${DEMO_DATA} --roles --grant

      - name: "failure logs"
        if: failure()
        run: |
          docker compose logs pum

      - uses: actions/upload-artifact@v5
        id: artifact
        if: github.event_name == 'pull_request'
        with:
          name: signalo-pr-testing
          path: |
            signalo-testing-db-dump-with-demo.backup
            project

      - name: Schedule download comment
        uses: ./.github/actions/post_sticky_comment
        if: github.event_name == 'pull_request'
        with:
          marker: pr-testing
          body: |
            ### Testing
            Download [demo data dump and QGIS project](${{ steps.artifact.outputs.artifact-url }}).
            *(Built from commit ${{ github.event.pull_request.head.sha }})*
          pr: ${{ github.event.number }}
