name: ðŸ§ª Run tests and deploy demo data

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

on:
  push:
    branches:
      - main
    paths-ignore:
      - 'website/**'
      - '.github/workflows/website.yml'
  pull_request:
    branches:
      - main
    paths-ignore:
      - 'website/**'
      - '.github/workflows/website.yml'
  workflow_dispatch:


jobs:
  version-tests:
    if: github.event_name == 'pull_request'
    name: Check versioning
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 2

      - name: Check changelog versions
        run: |
          LATEST_RELEASE=$(gh release view --json tagName -q .tagName | cut -d. -f1-2)
          echo "Latest release: $LATEST_RELEASE"
          if [ -z "$LATEST_RELEASE" ]; then
            echo "No release found."
            exit 1
          fi

          MODIFIED_FILES=$(git diff --name-only HEAD^1 HEAD)
          echo "*** Modified files:"
          echo "$MODIFIED_FILES"

          MODIFIED_CHANGELOGS=$(echo "$MODIFIED_FILES" | grep "^datamodel/changelogs/" || true)
          echo "Modified changelog files:"
          echo "$MODIFIED_CHANGELOGS"

          if [ -n "$MODIFIED_CHANGELOGS" ]; then
            for file in $MODIFIED_CHANGELOGS; do
              DIR=$(echo "$file" | cut -d'/' -f3)
              if (( $(echo "$DIR <= ${LATEST_RELEASE}" | bc -l) )); then
                echo "âŒ Error: Changelogs are modified in an already existing release directory: $DIR"
                exit 1
              fi
            done
          fi
          echo "âœ… Changelog versions are valid"

  docker-tests:
    name: Run tests and deploy demo data
    runs-on: ubuntu-latest

    env:
      DEMO_DATA: Lausanne
      REMOTE_DEMO_DB_NAME: signalo_testing
      PGSERVICE: pg_signalo
      DB_NAME: signalo
      RUN_TESTS: True

    steps:
      - uses: actions/checkout@v6

      - name: Initialize container
        run: |
          docker compose up --build -d
          until docker compose exec db pg_isready -U postgres; do
            echo "Waiting for PostgreSQL to be ready..."
            sleep 2
          done
          # create the database
          docker compose exec db sh -c "createdb -U postgres ${DB_NAME}"
          docker compose exec db sh -c "createdb -U postgres ${DB_NAME}_demo"
          docker compose run --rm pum -vvv -s ${PGSERVICE} -d datamodel install -p SRID 2056 --roles --grant
          docker compose run --rm pum -vvv -s ${PGSERVICE}_demo -d datamodel install -p SRID 2056 --demo-data ${DEMO_DATA} --roles --grant

      - name: "dumps + all signs"
        run: |
          docker compose exec db pg_dump -U postgres --format custom --exclude-schema=public --blobs --compress 5 --file signalo-testing-db-dump-with-demo.backup ${DB_NAME}_demo
          docker compose run --rm pum --entrypoint /usr/src/scripts/all-signs.py

#      - uses: actions/setup-node@v3
#        with:
#          node-version: '18'

      - name: "test data model"
        run: docker compose run --rm pum --entrypoint pytest

#      - name: "schema lint"
#        run: |
#          npm i --no-fund -g schemalint
#          cp .schemalintrc.js.template .schemalintrc.js
#          schemalint

      - name: Fix workspace permissions
        if: github.event_name != 'pull_request'
        run: sudo chown -R $USER:$USER ${GITHUB_WORKSPACE}

      - name: Deploy Demo DB
        if: github.event_name != 'pull_request'
        run: |
          set -euxo pipefail
          docker compose down -v
          # Write pg_service.conf with the remote service definition
          cat > pg_service.conf <<EOF
          [remote_db]
          host=${{ secrets.DEMO_DB_HOST }}
          port=${{ secrets.DEMO_DB_PORT }}
          dbname=${{ env.REMOTE_DEMO_DB_NAME }}
          user=${{ secrets.DEMO_DB_USER }}
          password=${{ secrets.DEMO_DB_PASSWORD }}
          EOF
          export PGSERVICE="remote_db"
          export PGSERVICEFILE="$(pwd)/pg_service.conf"
          docker compose up -d
          docker compose run --rm pum --entrypoint psql -v ON_ERROR_STOP=1 -c "DROP SCHEMA IF EXISTS signalo_app CASCADE; DROP SCHEMA IF EXISTS signalo_db CASCADE;"
          docker compose run --rm pum -vvv -s remote_db -d datamodel install -p SRID 2056 --demo-data ${DEMO_DATA} --roles --grant

      - name: "failure logs"
        if: failure()
        run: |
          docker compose logs pum

      - uses: actions/upload-artifact@v5
        id: artifact
        if: github.event_name == 'pull_request'
        with:
          name: signalo-pr-testing
          path: |
            signalo-testing-db-dump-with-demo.backup
            project

      - name: Schedule download comment
        uses: ./.github/actions/post_sticky_comment
        if: github.event_name == 'pull_request'
        with:
          marker: pr-testing
          body: |
            ### Testing
            Download [demo data dump and QGIS project](${{ steps.artifact.outputs.artifact-url }}).
            *(Built from commit ${{ github.event.pull_request.head.sha }})*
          pr: ${{ github.event.number }}
