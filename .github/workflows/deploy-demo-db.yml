name: ðŸ—„ï¸ Deploy Demo Database

concurrency:
  # NOTE: This workflow is called via `workflow_call`. Using `github.workflow` here
  # can resolve to the *caller* workflow name, which may cause a concurrency
  # deadlock (caller holds the lock while waiting for this workflow).
  # Lock per target database instead.
  group: deploy-demo-db-${{ inputs.db_name }}
  cancel-in-progress: true

on:
  workflow_call:
    inputs:
        db_name:
          required: true
          description: 'Database name to deploy the demo data into'
          type: string
  workflow_dispatch:
    inputs:
      db_name:
        description: 'Database name to deploy the demo data into'
        required: true
        default: signalo_testing
        type: string


jobs:
  deploy-demo-db:
    name: Deploy Demo Database
    runs-on: ubuntu-latest

    env:
      DEMO_DATA: Lausanne

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Deploy Demo DB
        run: |
          set -euxo pipefail
          docker compose down -v
          # Write pg_service.conf with the remote service definition
          cat > pg_service.conf <<EOF
          [remote_db]
          host=${{ secrets.DEMO_DB_HOST }}
          port=${{ secrets.DEMO_DB_PORT }}
          dbname=${{ inputs.db_name }}
          user=${{ secrets.DEMO_DB_USER }}
          password=${{ secrets.DEMO_DB_PASSWORD }}
          EOF
          export PGSERVICE="remote_db"
          export PGSERVICEFILE="$(pwd)/pg_service.conf"
          docker compose up -d
          docker compose exec -e PGSERVICE=remote_db db psql -v ON_ERROR_STOP=1 -c "DROP SCHEMA IF EXISTS signalo_app CASCADE; DROP SCHEMA IF EXISTS signalo_db CASCADE;"
          docker compose run pum -vvv -s remote_db -d datamodel install -p SRID 2056 --demo-data ${DEMO_DATA} --roles --grant
